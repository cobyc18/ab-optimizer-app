{% comment %}
{
  "name": "Live Visitor Count",
  "target": "section",
  "settings": [
    {
      "type": "header",
      "content": "Count Settings"
    },
    {
      "type": "number",
      "id": "count_min",
      "label": "Minimum Count",
      "default": 40,
      "info": "Minimum number of visitors to display"
    },
    {
      "type": "number",
      "id": "count_max",
      "label": "Maximum Count",
      "default": 60,
      "info": "Maximum number of visitors to display"
    },
    {
      "type": "header",
      "content": "Desktop Settings"
    },
    {
      "type": "text",
      "id": "desktop_text",
      "label": "Text After Count",
      "default": "people currently looking at this product",
      "info": "Text displayed after the visitor count"
    },
    {
      "type": "select",
      "id": "desktop_border_shape",
      "label": "Border Shape",
      "options": [
        { "value": "rounded", "label": "Rounded" },
        { "value": "rectangular", "label": "Rectangular" }
      ],
      "default": "rounded"
    },
    {
      "type": "range",
      "id": "desktop_padding_inside",
      "label": "Inside Padding",
      "min": 4,
      "max": 40,
      "step": 2,
      "default": 12,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "desktop_padding_outside",
      "label": "Outside Padding (Margin)",
      "min": 0,
      "max": 40,
      "step": 2,
      "default": 0,
      "unit": "px"
    },
    {
      "type": "select",
      "id": "desktop_font",
      "label": "Font Family",
      "options": [
        { "value": "system", "label": "System Default" },
        { "value": "arial", "label": "Arial" },
        { "value": "helvetica", "label": "Helvetica" },
        { "value": "georgia", "label": "Georgia" },
        { "value": "times", "label": "Times New Roman" },
        { "value": "courier", "label": "Courier New" }
      ],
      "default": "system"
    },
    {
      "type": "range",
      "id": "desktop_font_size",
      "label": "Font Size",
      "min": 10,
      "max": 24,
      "step": 1,
      "default": 14,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "desktop_width",
      "label": "Widget Width",
      "min": 200,
      "max": 800,
      "step": 10,
      "default": 400,
      "unit": "px",
      "info": "Set to 0 for auto width"
    },
    {
      "type": "range",
      "id": "desktop_height",
      "label": "Widget Height",
      "min": 40,
      "max": 120,
      "step": 4,
      "default": 60,
      "unit": "px",
      "info": "Set to 0 for auto height"
    },
    {
      "type": "select",
      "id": "desktop_alignment",
      "label": "Content Alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ],
      "default": "left"
    },
    {
      "type": "header",
      "content": "Mobile Settings"
    },
    {
      "type": "text",
      "id": "mobile_text",
      "label": "Text After Count (Mobile)",
      "default": "people currently looking at this product",
      "info": "Text displayed after the visitor count on mobile"
    },
    {
      "type": "select",
      "id": "mobile_border_shape",
      "label": "Border Shape (Mobile)",
      "options": [
        { "value": "rounded", "label": "Rounded" },
        { "value": "rectangular", "label": "Rectangular" }
      ],
      "default": "rounded"
    },
    {
      "type": "range",
      "id": "mobile_padding_inside",
      "label": "Inside Padding (Mobile)",
      "min": 4,
      "max": 40,
      "step": 2,
      "default": 10,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "mobile_padding_outside",
      "label": "Outside Padding (Mobile)",
      "min": 0,
      "max": 40,
      "step": 2,
      "default": 0,
      "unit": "px"
    },
    {
      "type": "select",
      "id": "mobile_font",
      "label": "Font Family (Mobile)",
      "options": [
        { "value": "system", "label": "System Default" },
        { "value": "arial", "label": "Arial" },
        { "value": "helvetica", "label": "Helvetica" },
        { "value": "georgia", "label": "Georgia" },
        { "value": "times", "label": "Times New Roman" },
        { "value": "courier", "label": "Courier New" }
      ],
      "default": "system"
    },
    {
      "type": "range",
      "id": "mobile_font_size",
      "label": "Font Size (Mobile)",
      "min": 10,
      "max": 24,
      "step": 1,
      "default": 12,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "mobile_width",
      "label": "Widget Width (Mobile)",
      "min": 150,
      "max": 600,
      "step": 10,
      "default": 300,
      "unit": "px",
      "info": "Set to 0 for auto width"
    },
    {
      "type": "range",
      "id": "mobile_height",
      "label": "Widget Height (Mobile)",
      "min": 40,
      "max": 120,
      "step": 4,
      "default": 50,
      "unit": "px",
      "info": "Set to 0 for auto height"
    },
    {
      "type": "select",
      "id": "mobile_alignment",
      "label": "Content Alignment (Mobile)",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ],
      "default": "left"
    }
  ]
}
{% endcomment %}

{% assign desktop_padding = block.settings.desktop_padding_inside | default: 12 %}
{% assign desktop_padding_h = desktop_padding | times: 1.5 | floor %}
{% assign desktop_border_radius = block.settings.desktop_border_shape | default: 'rounded' %}
{% assign desktop_border_radius_value = 12 %}
{% if desktop_border_radius != 'rounded' %}
  {% assign desktop_border_radius_value = 0 %}
{% endif %}

<div class="live-visitor-widget" 
     data-widget-id="visitor-{{ block.id }}"
     style="
       --desktop-padding: {{ desktop_padding }}px;
       --desktop-padding-h: {{ desktop_padding_h }}px;
       --desktop-padding-outside: {{ block.settings.desktop_padding_outside | default: 0 }}px;
       --desktop-border-radius: {{ desktop_border_radius_value }}px;
       --desktop-font-size: {{ block.settings.desktop_font_size | default: 14 }}px;
       --desktop-width: {% if block.settings.desktop_width > 0 %}{{ block.settings.desktop_width }}px{% else %}auto{% endif %};
       --desktop-height: {% if block.settings.desktop_height > 0 %}{{ block.settings.desktop_height }}px{% else %}auto{% endif %};
       --desktop-alignment: {{ block.settings.desktop_alignment | default: 'left' }};
       --mobile-padding: {{ block.settings.mobile_padding_inside | default: 10 }}px;
       --mobile-padding-h: {{ block.settings.mobile_padding_inside | default: 10 | times: 1.5 | floor }}px;
       --mobile-padding-outside: {{ block.settings.mobile_padding_outside | default: 0 }}px;
       --mobile-border-radius: {% if block.settings.mobile_border_shape == 'rounded' %}12{% else %}0{% endif %}px;
       --mobile-font-size: {{ block.settings.mobile_font_size | default: 12 }}px;
       --mobile-width: {% if block.settings.mobile_width > 0 %}{{ block.settings.mobile_width }}px{% else %}auto{% endif %};
       --mobile-height: {% if block.settings.mobile_height > 0 %}{{ block.settings.mobile_height }}px{% else %}auto{% endif %};
       --mobile-alignment: {{ block.settings.mobile_alignment | default: 'left' }};
     ">
  <svg class="eye-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z" fill="#667eea"/>
    <circle cx="12" cy="12" r="2.5" fill="white"/>
    <circle cx="12" cy="12" r="1.5" fill="#667eea"/>
  </svg>
  <span class="visitor-count" data-count="{{ block.settings.count_min | default: 40 }}">{{ block.settings.count_min | default: 40 }}</span>
  <span class="visitor-text desktop-text">{{ block.settings.desktop_text | default: "people currently looking at this product" }}</span>
  <span class="visitor-text mobile-text">{{ block.settings.mobile_text | default: "people currently looking at this product" }}</span>
</div>

<style>
.live-visitor-widget {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: white;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  color: #000000;
  border: none;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  position: relative;
  overflow: hidden;
  /* Desktop default values */
  padding: var(--desktop-padding) var(--desktop-padding-h);
  margin: var(--desktop-padding-outside);
  border-radius: var(--desktop-border-radius);
  font-size: var(--desktop-font-size);
  width: var(--desktop-width);
  {% if block.settings.desktop_height > 0 %}
    height: var(--desktop-height);
    min-height: var(--desktop-height);
  {% endif %}
  justify-content: var(--desktop-alignment);
}

/* Font family handling */
{% assign desktop_font = block.settings.desktop_font | default: 'system' %}
{% if desktop_font == 'arial' %}
  .live-visitor-widget { font-family: Arial, sans-serif; }
{% elsif desktop_font == 'helvetica' %}
  .live-visitor-widget { font-family: Helvetica, Arial, sans-serif; }
{% elsif desktop_font == 'georgia' %}
  .live-visitor-widget { font-family: Georgia, serif; }
{% elsif desktop_font == 'times' %}
  .live-visitor-widget { font-family: 'Times New Roman', Times, serif; }
{% elsif desktop_font == 'courier' %}
  .live-visitor-widget { font-family: 'Courier New', Courier, monospace; }
{% endif %}

.eye-icon {
  flex-shrink: 0;
  width: 20px;
  height: 20px;
}

.visitor-count {
  font-weight: 600;
  color: #000000;
  min-width: 28px;
  text-align: center;
}

.visitor-text {
  color: #000000;
  font-weight: 400;
}

.mobile-text {
  display: none;
}

/* Mobile styles */
@media (max-width: 768px) {
  .live-visitor-widget {
    padding: var(--mobile-padding) var(--mobile-padding-h);
    margin: var(--mobile-padding-outside);
    border-radius: var(--mobile-border-radius);
    font-size: var(--mobile-font-size);
    width: var(--mobile-width);
    {% if block.settings.mobile_height > 0 %}
      height: var(--mobile-height);
      min-height: var(--mobile-height);
    {% endif %}
    justify-content: var(--mobile-alignment);
  }

  {% assign mobile_font = block.settings.mobile_font | default: 'system' %}
  {% if mobile_font == 'arial' %}
    .live-visitor-widget { font-family: Arial, sans-serif; }
  {% elsif mobile_font == 'helvetica' %}
    .live-visitor-widget { font-family: Helvetica, Arial, sans-serif; }
  {% elsif mobile_font == 'georgia' %}
    .live-visitor-widget { font-family: Georgia, serif; }
  {% elsif mobile_font == 'times' %}
    .live-visitor-widget { font-family: 'Times New Roman', Times, serif; }
  {% elsif mobile_font == 'courier' %}
    .live-visitor-widget { font-family: 'Courier New', Courier, monospace; }
  {% endif %}

  .desktop-text {
    display: none;
  }

  .mobile-text {
    display: inline;
  }
}

.visitor-count.updating {
  animation: pulse 0.3s ease-in-out;
}

@keyframes pulse {
  0%, 100% { 
    opacity: 1;
    transform: scale(1);
  }
  50% { 
    opacity: 0.7;
    transform: scale(1.05);
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const widget = document.querySelector('[data-widget-id="visitor-{{ block.id }}"]');
  const countElement = widget?.querySelector('.visitor-count');
  
  if (!widget || !countElement) return;
  
  // Get settings
  const minCount = parseInt('{{ block.settings.count_min | default: 40 }}') || 40;
  const maxCount = parseInt('{{ block.settings.count_max | default: 60 }}') || 60;
  
  // Ensure min is less than max
  const validMin = Math.min(minCount, maxCount);
  const validMax = Math.max(minCount, maxCount);
  
  // Initialize count within range
  let currentCount = Math.max(validMin, Math.min(validMax, parseInt(countElement.dataset.count) || validMin));
  countElement.textContent = currentCount;
  countElement.dataset.count = currentCount;
  
  // Update visitor count within range
  function updateVisitorCount() {
    // Generate a random change between -2 and +2
    const change = Math.floor(Math.random() * 5) - 2; // -2 to +2
    let newCount = currentCount + change;
    
    // Clamp to valid range
    newCount = Math.max(validMin, Math.min(validMax, newCount));
    
    if (newCount !== currentCount) {
      countElement.classList.add('updating');
      currentCount = newCount;
      
      setTimeout(() => {
        countElement.textContent = currentCount;
        countElement.dataset.count = currentCount;
        countElement.classList.remove('updating');
      }, 150);
    }
  }
  
  // Update every 8-15 seconds
  function scheduleNextUpdate() {
    const delay = Math.random() * 7000 + 8000; // 8-15 seconds
    setTimeout(() => {
      updateVisitorCount();
      scheduleNextUpdate();
    }, delay);
  }
  
  // Start the live updates
  scheduleNextUpdate();
});
</script>

{% schema %}
{
  "name": "Live Visitor Count",
  "target": "section",
  "settings": [
    {
      "type": "header",
      "content": "Count Settings"
    },
    {
      "type": "number",
      "id": "count_min",
      "label": "Minimum Count",
      "default": 40,
      "info": "Minimum number of visitors to display"
    },
    {
      "type": "number",
      "id": "count_max",
      "label": "Maximum Count",
      "default": 60,
      "info": "Maximum number of visitors to display"
    },
    {
      "type": "header",
      "content": "Desktop Settings"
    },
    {
      "type": "text",
      "id": "desktop_text",
      "label": "Text After Count",
      "default": "people currently looking at this product",
      "info": "Text displayed after the visitor count"
    },
    {
      "type": "select",
      "id": "desktop_border_shape",
      "label": "Border Shape",
      "options": [
        { "value": "rounded", "label": "Rounded" },
        { "value": "rectangular", "label": "Rectangular" }
      ],
      "default": "rounded"
    },
    {
      "type": "range",
      "id": "desktop_padding_inside",
      "label": "Inside Padding",
      "min": 4,
      "max": 40,
      "step": 2,
      "default": 12,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "desktop_padding_outside",
      "label": "Outside Padding (Margin)",
      "min": 0,
      "max": 40,
      "step": 2,
      "default": 0,
      "unit": "px"
    },
    {
      "type": "select",
      "id": "desktop_font",
      "label": "Font Family",
      "options": [
        { "value": "system", "label": "System Default" },
        { "value": "arial", "label": "Arial" },
        { "value": "helvetica", "label": "Helvetica" },
        { "value": "georgia", "label": "Georgia" },
        { "value": "times", "label": "Times New Roman" },
        { "value": "courier", "label": "Courier New" }
      ],
      "default": "system"
    },
    {
      "type": "range",
      "id": "desktop_font_size",
      "label": "Font Size",
      "min": 10,
      "max": 24,
      "step": 1,
      "default": 14,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "desktop_width",
      "label": "Widget Width",
      "min": 200,
      "max": 800,
      "step": 10,
      "default": 400,
      "unit": "px",
      "info": "Set to 0 for auto width"
    },
    {
      "type": "range",
      "id": "desktop_height",
      "label": "Widget Height",
      "min": 40,
      "max": 120,
      "step": 4,
      "default": 60,
      "unit": "px",
      "info": "Set to 0 for auto height"
    },
    {
      "type": "select",
      "id": "desktop_alignment",
      "label": "Content Alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ],
      "default": "left"
    },
    {
      "type": "header",
      "content": "Mobile Settings"
    },
    {
      "type": "text",
      "id": "mobile_text",
      "label": "Text After Count (Mobile)",
      "default": "people currently looking at this product",
      "info": "Text displayed after the visitor count on mobile"
    },
    {
      "type": "select",
      "id": "mobile_border_shape",
      "label": "Border Shape (Mobile)",
      "options": [
        { "value": "rounded", "label": "Rounded" },
        { "value": "rectangular", "label": "Rectangular" }
      ],
      "default": "rounded"
    },
    {
      "type": "range",
      "id": "mobile_padding_inside",
      "label": "Inside Padding (Mobile)",
      "min": 4,
      "max": 40,
      "step": 2,
      "default": 10,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "mobile_padding_outside",
      "label": "Outside Padding (Mobile)",
      "min": 0,
      "max": 40,
      "step": 2,
      "default": 0,
      "unit": "px"
    },
    {
      "type": "select",
      "id": "mobile_font",
      "label": "Font Family (Mobile)",
      "options": [
        { "value": "system", "label": "System Default" },
        { "value": "arial", "label": "Arial" },
        { "value": "helvetica", "label": "Helvetica" },
        { "value": "georgia", "label": "Georgia" },
        { "value": "times", "label": "Times New Roman" },
        { "value": "courier", "label": "Courier New" }
      ],
      "default": "system"
    },
    {
      "type": "range",
      "id": "mobile_font_size",
      "label": "Font Size (Mobile)",
      "min": 10,
      "max": 24,
      "step": 1,
      "default": 12,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "mobile_width",
      "label": "Widget Width (Mobile)",
      "min": 150,
      "max": 600,
      "step": 10,
      "default": 300,
      "unit": "px",
      "info": "Set to 0 for auto width"
    },
    {
      "type": "range",
      "id": "mobile_height",
      "label": "Widget Height (Mobile)",
      "min": 40,
      "max": 120,
      "step": 4,
      "default": 50,
      "unit": "px",
      "info": "Set to 0 for auto height"
    },
    {
      "type": "select",
      "id": "mobile_alignment",
      "label": "Content Alignment (Mobile)",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ],
      "default": "left"
    }
  ]
}
{% endschema %}
