{% comment %}Master Widget Block - Supports multiple widget types{% endcomment %}
{% assign desktop_padding_h = block.settings.desktop_padding_inside | default: 12 | times: 1.5 | floor %}
{% assign mobile_padding_h = block.settings.mobile_padding_inside | default: 10 | times: 1.5 | floor %}
<div class="app-widget-container" 
     data-widget-type="{{ block.settings.widget_type | default: 'live-visitor-count' }}"
     data-widget-id="widget-{{ block.id }}"
     data-block-id="{{ block.id }}"
     {% comment %}Live Visitor Count Settings{% endcomment %}
     data-count-min="{{ block.settings.count_min | default: 40 }}"
     data-count-max="{{ block.settings.count_max | default: 60 }}"
     data-desktop-text="{{ block.settings.desktop_text | default: 'people currently looking at this product' }}"
     data-mobile-text="{{ block.settings.mobile_text | default: 'people currently looking at this product' }}"
     data-desktop-border-shape="{{ block.settings.desktop_border_shape | default: 'rounded' }}"
     data-mobile-border-shape="{{ block.settings.mobile_border_shape | default: 'rounded' }}"
     data-desktop-padding-inside="{{ block.settings.desktop_padding_inside | default: 12 }}"
     data-desktop-padding-outside="{{ block.settings.desktop_padding_outside | default: 0 }}"
     data-mobile-padding-inside="{{ block.settings.mobile_padding_inside | default: 10 }}"
     data-mobile-padding-outside="{{ block.settings.mobile_padding_outside | default: 0 }}"
     data-desktop-padding-h="{{ desktop_padding_h }}"
     data-mobile-padding-h="{{ mobile_padding_h }}"
     data-desktop-font="{{ block.settings.desktop_font | default: 'system' }}"
     data-mobile-font="{{ block.settings.mobile_font | default: 'system' }}"
     data-desktop-font-size="{{ block.settings.desktop_font_size | default: 14 }}"
     data-mobile-font-size="{{ block.settings.mobile_font_size | default: 12 }}"
     data-desktop-width="{{ block.settings.desktop_width | default: 400 }}"
     data-mobile-width="{{ block.settings.mobile_width | default: 300 }}"
     data-desktop-height="{{ block.settings.desktop_height | default: 60 }}"
     data-mobile-height="{{ block.settings.mobile_height | default: 48 }}"
     data-desktop-alignment="{{ block.settings.desktop_alignment | default: 'left' }}"
     data-mobile-alignment="{{ block.settings.mobile_alignment | default: 'left' }}"
     {% comment %}Product Carousel Settings{% endcomment %}
     data-carousel-title="{{ block.settings.carousel_title | default: 'You may also like' }}"
     data-show-navigation="{{ block.settings.show_navigation | default: true }}"
     data-show-pagination="{{ block.settings.show_pagination | default: true }}"
     {% comment %}Products data - will be passed as JSON{% endcomment %}
     data-products='{% if block.settings.products %}{% assign products_json = block.settings.products | map: "id" | join: "," %}{{ products_json }}{% endif %}'>
  {% comment %}Render widget based on type{% endcomment %}
  {% if block.settings.widget_type == 'product-carousel' %}
    {% comment %}Product Carousel - Render products server-side{% endcomment %}
    <div class="product-carousel-widget" data-carousel-id="carousel-{{ block.id }}">
      <div class="carousel-header">
        <h3 class="carousel-title">{{ block.settings.carousel_title | default: 'You may also like' }}</h3>
        {% if block.settings.show_navigation %}
          <div class="carousel-navigation">
            <button class="nav-arrow nav-prev" data-direction="prev">‹</button>
            <button class="nav-arrow nav-next" data-direction="next">›</button>
          </div>
        {% endif %}
      </div>
      <div class="carousel-container">
        <div class="carousel-track" data-carousel-track>
          {% for product in block.settings.products limit: 10 %}
            <div class="carousel-slide">
              <div class="product-card">
                {% if product.featured_image %}
                  <img src="{{ product.featured_image | img_url: '200x200' }}" 
                       alt="{{ product.title }}" 
                       class="product-image"
                       loading="lazy">
                {% endif %}
                <div class="product-info">
                  <div class="product-header">
                    <h4 class="product-title">{{ product.title }}</h4>
                  </div>
                  <div class="product-content">
                    {% if product.variants.size > 1 %}
                      <div class="product-options">
                        {% for variant in product.variants limit: 2 %}
                          <button class="variant-option" data-variant-id="{{ variant.id }}">
                            {{ variant.title }}
                          </button>
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                  <div class="product-footer">
                    <div class="product-price">
                      {% if product.compare_at_price > product.price %}
                        <span class="price-original">{{ product.compare_at_price | money }}</span>
                        <span class="price-sale">{{ product.price | money }}</span>
                        {% assign discount_percent = product.compare_at_price | minus: product.price | times: 100 | divided_by: product.compare_at_price %}
                        <span class="sale-badge">{{ discount_percent | round }}% OFF</span>
                      {% else %}
                        <span class="price-regular">{{ product.price | money }}</span>
                      {% endif %}
                    </div>
                    {% assign available_variant = product.selected_or_first_available_variant %}
                    {% if available_variant %}
                      <button class="add-to-cart-btn{% if forloop.index > 3 %} plus{% endif %}" 
                              data-product-id="{{ product.id }}"
                              data-variant-id="{{ available_variant.id }}"
                              data-variant-title="{{ available_variant.title }}"
                              data-product-title="{{ product.title }}">
                        {% if forloop.index > 3 %}+ {% endif %}Add
                      </button>
                    {% else %}
                      <button class="add-to-cart-btn disabled" disabled>
                        Sold Out
                      </button>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
      {% if block.settings.show_pagination %}
        <div class="carousel-pagination" data-carousel-pagination>
          {% for product in block.settings.products limit: 10 %}
            <button class="pagination-dot" data-slide="{{ forloop.index0 }}"></button>
          {% endfor %}
        </div>
      {% endif %}
    </div>
  {% else %}
    {% comment %}Live Visitor Count - Will be rendered by JavaScript{% endcomment %}
  {% endif %}
</div>

{% schema %}
{
  "name": "App Widget",
  "target": "section",
  "stylesheet": "widget.css",
  "javascript": "widget.js",
  "settings": [
    {
      "type": "header",
      "content": "Widget Type"
    },
    {
      "type": "select",
      "id": "widget_type",
      "label": "Select Widget",
      "options": [
        { "value": "live-visitor-count", "label": "Live Visitor Count" },
        { "value": "product-carousel", "label": "Product Carousel" }
      ],
      "default": "live-visitor-count",
      "info": "Choose which widget to display"
    },
    {
      "type": "header",
      "content": "Live Visitor Count Settings",
      "info": "These settings apply to the Live Visitor Count widget",
      "visible_if": "{{ block.settings.widget_type == 'live-visitor-count' }}"
    },
    {
      "type": "number",
      "id": "count_min",
      "label": "Minimum Count",
      "default": 40,
      "info": "Minimum number of visitors to display",
      "visible_if": "{{ block.settings.widget_type == 'live-visitor-count' }}"
    },
    {
      "type": "number",
      "id": "count_max",
      "label": "Maximum Count",
      "default": 60,
      "info": "Maximum number of visitors to display",
      "visible_if": "{{ block.settings.widget_type == 'live-visitor-count' }}"
    },
    {
      "type": "text",
      "id": "desktop_text",
      "label": "Text After Count (Desktop)",
      "default": "people currently looking at this product",
      "info": "Text displayed after the visitor count",
      "visible_if": "{{ block.settings.widget_type == 'live-visitor-count' }}"
    },
    {
      "type": "text",
      "id": "mobile_text",
      "label": "Text After Count (Mobile)",
      "default": "people currently looking at this product",
      "info": "Text displayed after the visitor count on mobile",
      "visible_if": "{{ block.settings.widget_type == 'live-visitor-count' }}"
    },
    {
      "type": "select",
      "id": "desktop_border_shape",
      "label": "Border Shape (Desktop)",
      "options": [
        { "value": "rounded", "label": "Rounded" },
        { "value": "rectangular", "label": "Rectangular" }
      ],
      "default": "rounded",
      "visible_if": "{{ block.settings.widget_type == 'live-visitor-count' }}"
    },
    {
      "type": "select",
      "id": "mobile_border_shape",
      "label": "Border Shape (Mobile)",
      "options": [
        { "value": "rounded", "label": "Rounded" },
        { "value": "rectangular", "label": "Rectangular" }
      ],
      "default": "rounded",
      "visible_if": "{{ block.settings.widget_type == 'live-visitor-count' }}"
    },
    {
      "type": "range",
      "id": "desktop_padding_inside",
      "label": "Inside Padding (Desktop)",
      "min": 4,
      "max": 40,
      "step": 2,
      "default": 12,
      "unit": "px",
      "visible_if": "{{ block.settings.widget_type == 'live-visitor-count' }}"
    },
    {
      "type": "range",
      "id": "desktop_padding_outside",
      "label": "Outside Padding (Desktop)",
      "min": 0,
      "max": 40,
      "step": 2,
      "default": 0,
      "unit": "px",
      "visible_if": "{{ block.settings.widget_type == 'live-visitor-count' }}"
    },
    {
      "type": "range",
      "id": "mobile_padding_inside",
      "label": "Inside Padding (Mobile)",
      "min": 4,
      "max": 40,
      "step": 2,
      "default": 10,
      "unit": "px",
      "visible_if": "{{ block.settings.widget_type == 'live-visitor-count' }}"
    },
    {
      "type": "range",
      "id": "mobile_padding_outside",
      "label": "Outside Padding (Mobile)",
      "min": 0,
      "max": 40,
      "step": 2,
      "default": 0,
      "unit": "px",
      "visible_if": "{{ block.settings.widget_type == 'live-visitor-count' }}"
    },
    {
      "type": "select",
      "id": "desktop_font",
      "label": "Font Family (Desktop)",
      "options": [
        { "value": "system", "label": "System Default" },
        { "value": "arial", "label": "Arial" },
        { "value": "helvetica", "label": "Helvetica" },
        { "value": "georgia", "label": "Georgia" },
        { "value": "times", "label": "Times New Roman" },
        { "value": "courier", "label": "Courier New" }
      ],
      "default": "system",
      "visible_if": "{{ block.settings.widget_type == 'live-visitor-count' }}"
    },
    {
      "type": "select",
      "id": "mobile_font",
      "label": "Font Family (Mobile)",
      "options": [
        { "value": "system", "label": "System Default" },
        { "value": "arial", "label": "Arial" },
        { "value": "helvetica", "label": "Helvetica" },
        { "value": "georgia", "label": "Georgia" },
        { "value": "times", "label": "Times New Roman" },
        { "value": "courier", "label": "Courier New" }
      ],
      "default": "system",
      "visible_if": "{{ block.settings.widget_type == 'live-visitor-count' }}"
    },
    {
      "type": "range",
      "id": "desktop_font_size",
      "label": "Font Size (Desktop)",
      "min": 10,
      "max": 24,
      "step": 1,
      "default": 14,
      "unit": "px",
      "visible_if": "{{ block.settings.widget_type == 'live-visitor-count' }}"
    },
    {
      "type": "range",
      "id": "mobile_font_size",
      "label": "Font Size (Mobile)",
      "min": 10,
      "max": 24,
      "step": 1,
      "default": 12,
      "unit": "px",
      "visible_if": "{{ block.settings.widget_type == 'live-visitor-count' }}"
    },
    {
      "type": "range",
      "id": "desktop_width",
      "label": "Widget Width (Desktop)",
      "min": 200,
      "max": 800,
      "step": 10,
      "default": 400,
      "unit": "px",
      "info": "Set to 0 for auto width",
      "visible_if": "{{ block.settings.widget_type == 'live-visitor-count' }}"
    },
    {
      "type": "range",
      "id": "mobile_width",
      "label": "Widget Width (Mobile)",
      "min": 150,
      "max": 600,
      "step": 10,
      "default": 300,
      "unit": "px",
      "info": "Set to 0 for auto width",
      "visible_if": "{{ block.settings.widget_type == 'live-visitor-count' }}"
    },
    {
      "type": "range",
      "id": "desktop_height",
      "label": "Widget Height (Desktop)",
      "min": 40,
      "max": 120,
      "step": 4,
      "default": 60,
      "unit": "px",
      "info": "Set to 0 for auto height",
      "visible_if": "{{ block.settings.widget_type == 'live-visitor-count' }}"
    },
    {
      "type": "range",
      "id": "mobile_height",
      "label": "Widget Height (Mobile)",
      "min": 40,
      "max": 120,
      "step": 4,
      "default": 48,
      "unit": "px",
      "info": "Set to 0 for auto height",
      "visible_if": "{{ block.settings.widget_type == 'live-visitor-count' }}"
    },
    {
      "type": "select",
      "id": "desktop_alignment",
      "label": "Content Alignment (Desktop)",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ],
      "default": "left",
      "visible_if": "{{ block.settings.widget_type == 'live-visitor-count' }}"
    },
    {
      "type": "select",
      "id": "mobile_alignment",
      "label": "Content Alignment (Mobile)",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ],
      "default": "left",
      "visible_if": "{{ block.settings.widget_type == 'live-visitor-count' }}"
    },
    {
      "type": "header",
      "content": "Product Carousel Settings",
      "info": "These settings apply to the Product Carousel widget",
      "visible_if": "{{ block.settings.widget_type == 'product-carousel' }}"
    },
    {
      "type": "text",
      "id": "carousel_title",
      "label": "Carousel Title",
      "default": "You may also like",
      "visible_if": "{{ block.settings.widget_type == 'product-carousel' }}"
    },
    {
      "type": "product_list",
      "id": "products",
      "label": "Products to display",
      "limit": 10
    },
    {
      "type": "checkbox",
      "id": "show_navigation",
      "label": "Show navigation arrows",
      "default": true,
      "visible_if": "{{ block.settings.widget_type == 'product-carousel' }}"
    },
    {
      "type": "checkbox",
      "id": "show_pagination",
      "label": "Show pagination dots",
      "default": true,
      "visible_if": "{{ block.settings.widget_type == 'product-carousel' }}"
    }
  ]
}
{% endschema %}

