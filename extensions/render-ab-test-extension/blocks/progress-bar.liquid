{% comment %}
  Progress Bar Widget
  Displays progress bars for various purposes like stock levels, goal progress, etc.
{% endcomment %}

<div class="ab-optimizer-progress" 
     style="
       padding: {{ block.settings.padding }}px;
       background: {{ block.settings.background_color }};
       border-radius: {{ block.settings.border_radius }}px;
       border: {{ block.settings.border_width }}px solid {{ block.settings.border_color }};
       margin: {{ block.settings.margin }}px 0;
     ">

  {% case block.settings.progress_type %}
    {% when 'stock_level' %}
      {% assign current_stock = product.inventory_quantity | default: block.settings.current_value %}
      {% assign max_stock = block.settings.max_value | default: 100 %}
      {% assign percentage = current_stock | times: 100.0 | divided_by: max_stock | at_least: 0 | at_most: 100 %}
      
      <div class="progress-header" style="
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 8px;
        color: {{ block.settings.text_color }};
      ">
        <span style="font-size: {{ block.settings.font_size }}px; font-weight: bold;">
          Stock Level
        </span>
        <span style="font-size: {{ block.settings.font_size | minus: 2 }}px;">
          {{ current_stock }}/{{ max_stock }}
        </span>
      </div>

    {% when 'goal_progress' %}
      {% assign current_value = block.settings.current_value %}
      {% assign goal_value = block.settings.goal_value %}
      {% assign percentage = current_value | times: 100.0 | divided_by: goal_value | at_least: 0 | at_most: 100 %}
      
      <div class="progress-header" style="
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 8px;
        color: {{ block.settings.text_color }};
      ">
        <span style="font-size: {{ block.settings.font_size }}px; font-weight: bold;">
          Goal Progress
        </span>
        <span style="font-size: {{ block.settings.font_size | minus: 2 }}px;">
          {{ percentage | round: 1 }}%
        </span>
      </div>

    {% when 'custom' %}
      {% assign percentage = block.settings.custom_percentage | at_least: 0 | at_most: 100 %}
      
      <div class="progress-header" style="
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 8px;
        color: {{ block.settings.text_color }};
      ">
        <span style="font-size: {{ block.settings.font_size }}px; font-weight: bold;">
          {{ block.settings.custom_label | default: 'Progress' }}
        </span>
        <span style="font-size: {{ block.settings.font_size | minus: 2 }}px;">
          {{ percentage }}%
        </span>
      </div>
  {% endcase %}

  <!-- Progress Bar -->
  <div class="progress-bar-container" style="
    width: 100%;
    height: {{ block.settings.bar_height }}px;
    background: {{ block.settings.bar_background }};
    border-radius: 4px;
    overflow: hidden;
    position: relative;
  ">
    <div class="progress-bar-fill" style="
      height: 100%;
      width: {{ percentage }}%;
      background: {{ block.settings.bar_fill_color }};
      border-radius: 4px;
      transition: width 0.3s ease;
    "></div>
  </div>

  <!-- Progress Message -->
  {% if block.settings.show_message %}
    <div class="progress-message" style="
      margin-top: 8px;
      font-size: {{ block.settings.font_size | minus: 2 }}px; 
      color: {{ block.settings.text_color }};
      opacity: 0.8;
      text-align: center;
    ">
      {% case block.settings.progress_type %}
        {% when 'stock_level' %}
          {% if percentage <= 20 %}
            Low stock - order soon!
          {% elsif percentage <= 50 %}
            Stock is running out!
          {% else %}
            In stock and ready to ship!
          {% endif %}
        {% when 'goal_progress' %}
          {% if percentage >= 100 %}
            Goal achieved!
          {% elsif percentage >= 75 %}
            Almost there!
          {% else %}
            Keep going!
          {% endif %}
        {% when 'custom' %}
          {{ block.settings.custom_message | default: 'Progress update' }}
      {% endcase %}
    </div>
  {% endif %}
</div>

{% schema %}
{
  "name": "Progress Bar",
  "target": "section",
  "settings": [
    {
      "type": "select",
      "id": "progress_type",
      "label": "Progress Type",
      "options": [
        { "value": "stock_level", "label": "Stock Level" },
        { "value": "goal_progress", "label": "Goal Progress" },
        { "value": "custom", "label": "Custom Progress" }
      ],
      "default": "stock_level"
    },
    {
      "type": "text",
      "id": "custom_label",
      "label": "Custom Label",
      "default": "Progress"
    },
    {
      "type": "number",
      "id": "current_value",
      "label": "Current Value",
      "default": 50
    },
    {
      "type": "number",
      "id": "max_value",
      "label": "Max Value (Stock)",
      "default": 100
    },
    {
      "type": "number",
      "id": "goal_value",
      "label": "Goal Value",
      "default": 100
    },
    {
      "type": "range",
      "id": "custom_percentage",
      "label": "Custom Percentage",
      "min": 0,
      "max": 100,
      "step": 1,
      "default": 75
    },
    {
      "type": "text",
      "id": "custom_message",
      "label": "Custom Message",
      "default": "Progress update"
    },
    {
      "type": "checkbox",
      "id": "show_message",
      "label": "Show Progress Message",
      "default": true
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text Color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "bar_background",
      "label": "Bar Background Color",
      "default": "#e5e7eb"
    },
    {
      "type": "color",
      "id": "bar_fill_color",
      "label": "Bar Fill Color",
      "default": "#32cd32"
    },
    {
      "type": "color",
      "id": "border_color",
      "label": "Border Color",
      "default": "#e5e7eb"
    },
    {
      "type": "range",
      "id": "border_width",
      "label": "Border Width",
      "min": 0,
      "max": 5,
      "step": 1,
      "default": 1
    },
    {
      "type": "range",
      "id": "border_radius",
      "label": "Border Radius",
      "min": 0,
      "max": 20,
      "step": 1,
      "default": 8
    },
    {
      "type": "range",
      "id": "padding",
      "label": "Padding",
      "min": 8,
      "max": 32,
      "step": 1,
      "default": 16
    },
    {
      "type": "range",
      "id": "margin",
      "label": "Margin",
      "min": 0,
      "max": 20,
      "step": 1,
      "default": 8
    },
    {
      "type": "range",
      "id": "font_size",
      "label": "Font Size",
      "min": 12,
      "max": 24,
      "step": 1,
      "default": 14
    },
    {
      "type": "range",
      "id": "bar_height",
      "label": "Bar Height",
      "min": 8,
      "max": 32,
      "step": 1,
      "default": 12
    }
  ]
}
{% endschema %} 